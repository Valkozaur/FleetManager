version: '3.8'

services:
  fleetmanager:
    build: .
    container_name: fleetmanager
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      # Persist data and tokens
      - fleetmanager_data:/app/data
      - fleetmanager_logs:/app/logs
      # Mount credentials (you'll need to provide these)
      - ./credentials:/app/credentials:ro
    environment:
      - DATA_DIR=/app/data
      - GMAIL_CREDENTIALS_FILE=/app/credentials/credentials.json
    networks:
      - fleetmanager_network
    # Optional: Add resource limits
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Optional: Add cron service for automated execution
  fleetmanager-cron:
    build: .
    container_name: fleetmanager-cron
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - fleetmanager_data:/app/data
      - fleetmanager_logs:/app/logs
      - ./credentials:/app/credentials:ro
    environment:
      - DATA_DIR=/app/data
      - GMAIL_CREDENTIALS_FILE=/app/credentials/credentials.json
    networks:
      - fleetmanager_network
    command: >
      sh -c "
      # Install cron if not present
      apt-get update && apt-get install -y cron &&
      # Create cron job to run every 5 minutes
      echo '*/5 * * * * cd /app && python src/orders/poller/main.py >> /app/logs/cron.log 2>&1' > /etc/cron.d/fleetmanager-cron &&
      # Give execution rights on the cron job
      chmod 0644 /etc/cron.d/fleetmanager-cron &&
      # Apply cron job
      crontab /etc/cron.d/fleetmanager-cron &&
      # Start cron daemon
      cron -f
      "
    depends_on:
      - fleetmanager

volumes:
  fleetmanager_data:
    driver: local
  fleetmanager_logs:
    driver: local

networks:
  fleetmanager_network:
    driver: bridge